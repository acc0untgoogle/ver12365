<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة شوتر ثلاثية الأبعاد</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        canvas { 
            display: block; 
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }
        #health {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 20px;
            background: rgba(255,0,0,0.5);
        }
        #health-bar {
            height: 100%;
            width: 100%;
            background: rgba(0,255,0,0.7);
        }
        #ammo {
            position: absolute;
            bottom: 50px;
            left: 20px;
            color: white;
            font-size: 18px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 48px;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="info">
        لعبة شوتر ثلاثية الأبعاد | WASD للحركة | مسافة للقفز | زر الفأرة لإطلاق النار
    </div>
    <div id="health">
        <div id="health-bar"></div>
    </div>
    <div id="ammo">الذخيرة: ∞</div>
    <div id="game-over">انتهت اللعبة! <br> <button onclick="resetGame()">إعادة المحاولة</button></div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/misc/FirstPersonControls.js"></script>

    <script>
        // المشهد الأساسي
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // لون السماء
        
        // الكاميرا
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.y = 10;
        
        // الرسام
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // التحكم بالمؤشر
        const controls = new THREE.PointerLockControls(camera, document.body);
        
        // الإضاءة
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 1);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        // الأرض
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);
        
        // الجدران أو العوائق
        const wallGeometry = new THREE.BoxGeometry(10, 10, 1);
        const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
        
        for (let i = 0; i < 5; i++) {
            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
            wall.position.x = Math.random() * 80 - 40;
            wall.position.z = Math.random() * 80 - 40;
            wall.position.y = 5;
            wall.castShadow = true;
            wall.receiveShadow = true;
            scene.add(wall);
        }
        
        // اللاعب
        const playerGeometry = new THREE.BoxGeometry(1, 2, 1);
        const playerMaterial = new THREE.MeshStandardMaterial({ color: 0x0000FF });
        const player = new THREE.Mesh(playerGeometry, playerMaterial);
        player.position.y = 2;
        player.castShadow = true;
        scene.add(player);
        
        // السلاح
        const weaponGeometry = new THREE.BoxGeometry(0.5, 0.2, 1.5);
        const weaponMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
        const weapon = new THREE.Mesh(weaponGeometry, weaponMaterial);
        weapon.position.set(0.5, -0.3, -1);
        camera.add(weapon);
        
        // متغيرات اللعبة
        const enemies = [];
        const bullets = [];
        let health = 100;
        let score = 0;
        let gameOver = false;
        let enemySpawnInterval;
        
        // حركة اللاعب
        const moveSpeed = 0.2;
        const jumpForce = 0.5;
        let velocityY = 0;
        let isOnGround = false;
        
        // إضافة الأعداء
        function spawnEnemy() {
            if (gameOver) return;
            
            const enemyGeometry = new THREE.BoxGeometry(1, 2, 1);
            const enemyMaterial = new THREE.MeshStandardMaterial({ color: 0xFF0000 });
            const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
            
            // وضع العدو في مكان عشوائي بعيد عن اللاعب
            let x, z;
            do {
                x = Math.random() * 80 - 40;
                z = Math.random() * 80 - 40;
            } while (Math.sqrt(x*x + z*z) < 15); // التأكد من أنه ليس قريبًا جدًا
            
            enemy.position.set(x, 1, z);
            enemy.castShadow = true;
            
            // خصائص العدو
            enemy.health = 100;
            enemy.speed = 0.05 + Math.random() * 0.05;
            enemy.damage = 10;
            enemy.lastShotTime = 0;
            enemy.shotDelay = 2000 + Math.random() * 1000; // بين 2-3 ثواني
            
            scene.add(enemy);
            enemies.push(enemy);
        }
        
        // إطلاق النار
        function shoot() {
            if (gameOver) return;
            
            const bulletGeometry = new THREE.SphereGeometry(0.1, 16, 16);
            const bulletMaterial = new THREE.MeshStandardMaterial({ color: 0xFFFF00 });
            const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
            
            // وضع الرصاصة أمام الكاميرا
            bullet.position.copy(camera.position);
            
            // تحديد اتجاه الرصاصة
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            bullet.userData.direction = direction.clone();
            
            bullet.castShadow = true;
            scene.add(bullet);
            bullets.push(bullet);
            
            // تأثير صوتي (يمكن إضافة صوت حقيقي هنا)
            console.log("Bang!");
        }
        
        // تحديث حركة الأعداء
        function updateEnemies() {
            const currentTime = Date.now();
            
            enemies.forEach((enemy, index) => {
                if (enemy.health <= 0) {
                    scene.remove(enemy);
                    enemies.splice(index, 1);
                    score += 10;
                    return;
                }
                
                // تحرك نحو اللاعب
                const direction = new THREE.Vector3();
                direction.subVectors(player.position, enemy.position).normalize();
                enemy.position.x += direction.x * enemy.speed;
                enemy.position.z += direction.z * enemy.speed;
                
                // إطلاق النار على اللاعب
                if (currentTime - enemy.lastShotTime > enemy.shotDelay) {
                    enemy.lastShotTime = currentTime;
                    
                    // حساب إذا كان اللاعب في مرمى النظر
                    const toPlayer = new THREE.Vector3().subVectors(player.position, enemy.position).normalize();
                    const enemyDirection = new THREE.Vector3(0, 0, -1).applyQuaternion(enemy.quaternion);
                    
                    if (toPlayer.dot(enemyDirection) > 0.9) { // زاوية رؤية 25 درجة تقريبًا
                        const enemyBulletGeometry = new THREE.SphereGeometry(0.1, 16, 16);
                        const enemyBulletMaterial = new THREE.MeshStandardMaterial({ color: 0xFF4500 });
                        const enemyBullet = new THREE.Mesh(enemyBulletGeometry, enemyBulletMaterial);
                        
                        enemyBullet.position.copy(enemy.position);
                        enemyBullet.position.y += 1; // إطلاق من مستوى الرأس
                        
                        const bulletDirection = new THREE.Vector3().subVectors(player.position, enemyBullet.position).normalize();
                        enemyBullet.userData.direction = bulletDirection;
                        enemyBullet.userData.isEnemyBullet = true;
                        
                        scene.add(enemyBullet);
                        bullets.push(enemyBullet);
                    }
                }
                
                // تدوير العدو لمواجهة اللاعب
                enemy.lookAt(player.position);
            });
        }
        
        // تحديث حركة الرصاصات
        function updateBullets() {
            bullets.forEach((bullet, index) => {
                // حركة الرصاصة
                bullet.position.x += bullet.userData.direction.x * 0.5;
                bullet.position.y += bullet.userData.direction.y * 0.5;
                bullet.position.z += bullet.userData.direction.z * 0.5;
                
                // التحقق من اصطدام الرصاصة بالعدو (إذا كانت من اللاعب)
                if (!bullet.userData.isEnemyBullet) {
                    enemies.forEach(enemy => {
                        if (bullet.position.distanceTo(enemy.position) < 1) {
                            enemy.health -= 25;
                            scene.remove(bullet);
                            bullets.splice(index, 1);
                        }
                    });
                }
                // التحقق من اصطدام الرصاصة باللاعب (إذا كانت من العدو)
                else if (bullet.position.distanceTo(player.position) < 1) {
                    health -= 10;
                    updateHealthBar();
                    scene.remove(bullet);
                    bullets.splice(index, 1);
                    
                    if (health <= 0) {
                        endGame();
                    }
                }
                
                // إزالة الرصاصة إذا تجاوزت الحدود
                if (Math.abs(bullet.position.x) > 50 || 
                    Math.abs(bullet.position.y) > 50 || 
                    Math.abs(bullet.position.z) > 50) {
                    scene.remove(bullet);
                    bullets.splice(index, 1);
                }
            });
        }
        
        // تحديث شريط الصحة
        function updateHealthBar() {
            const healthBar = document.getElementById('health-bar');
            healthBar.style.width = `${health}%`;
            
            if (health < 30) {
                healthBar.style.background = 'rgba(255,0,0,0.7)';
            } else if (health < 60) {
                healthBar.style.background = 'rgba(255,165,0,0.7)';
            } else {
                healthBar.style.background = 'rgba(0,255,0,0.7)';
            }
        }
        
        // إنهاء اللعبة
        function endGame() {
            gameOver = true;
            document.getElementById('game-over').style.display = 'block';
            clearInterval(enemySpawnInterval);
        }
        
        // إعادة تشغيل اللعبة
        function resetGame() {
            health = 100;
            score = 0;
            gameOver = false;
            updateHealthBar();
            document.getElementById('game-over').style.display = 'none';
            
            // إزالة جميع الأعداء والرصاصات
            enemies.forEach(enemy => scene.remove(enemy));
            bullets.forEach(bullet => scene.remove(bullet));
            enemies.length = 0;
            bullets.length = 0;
            
            // إعادة تعيين موقع اللاعب
            player.position.set(0, 2, 0);
            camera.position.set(0, 10, 0);
            controls.getObject().position.set(0, 10, 0);
            
            // إعادة تشغيل موجة الأعداء
            enemySpawnInterval = setInterval(spawnEnemy, 3000);
        }
        
        // التحكم باللوحة المفاتيح
        const keys = {};
        document.addEventListener('keydown', (event) => {
            keys[event.code] = true;
            
            // القفز
            if (event.code === 'Space' && isOnGround) {
                velocityY = jumpForce;
                isOnGround = false;
            }
            
            // قفل المؤشر عند النقر
            if (event.code === 'Enter' && !controls.isLocked) {
                controls.lock();
            }
        });
        
        document.addEventListener('keyup', (event) => {
            keys[event.code] = false;
        });
        
        // التحكم بالفأرة
        document.addEventListener('click', () => {
            if (controls.isLocked) {
                shoot();
            } else {
                controls.lock();
            }
        });
        
        // تحديث الحركة
        function updateMovement() {
            if (!controls.isLocked || gameOver) return;
            
            const direction = new THREE.Vector3();
            const frontVector = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            const sideVector = new THREE.Vector3(-1, 0, 0).applyQuaternion(camera.quaternion);
            
            if (keys['KeyW']) direction.add(frontVector);
            if (keys['KeyS']) direction.sub(frontVector);
            if (keys['KeyA']) direction.add(sideVector);
            if (keys['KeyD']) direction.sub(sideVector);
            
            direction.normalize();
            
            if (direction.length() > 0) {
                player.position.x += direction.x * moveSpeed;
                player.position.z += direction.z * moveSpeed;
            }
            
            // الجاذبية
            velocityY -= 0.02;
            player.position.y += velocityY;
            
            // التحقق من الاصطدام بالأرض
            if (player.position.y <= 1) {
                player.position.y = 1;
                velocityY = 0;
                isOnGround = true;
            }
            
            // تحديث موقع الكاميرا لاتباع اللاعب
            camera.position.x = player.position.x;
            camera.position.z = player.position.z;
            controls.getObject().position.copy(camera.position);
        }
        
        // دورة اللعبة
        function gameLoop() {
            if (!gameOver) {
                updateMovement();
                updateEnemies();
                updateBullets();
            }
            
            renderer.render(scene, camera);
            requestAnimationFrame(gameLoop);
        }
        
        // بدء اللعبة
        enemySpawnInterval = setInterval(spawnEnemy, 3000);
        gameLoop();
        
        // تعديل الحجم عند تغيير حجم النافذة
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
